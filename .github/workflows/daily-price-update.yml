name: Update Prices

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch: # Manual trigger option

permissions:
  contents: write

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Install dependencies
        run: npm install

      - name: Fetch live prices from Netlify Function
        run: |
          curl -s "https://perfpertco.netlify.app/.netlify/functions/fetch-price?gpu=H100" > h100-price.json
          curl -s "https://perfpertco.netlify.app/.netlify/functions/fetch-price?gpu=GH200" > gh200-price.json
          curl -s "https://perfpertco.netlify.app/.netlify/functions/fetch-price?gpu=A100" > a100-price.json
          curl -s "https://perfpertco.netlify.app/.netlify/functions/fetch-price?gpu=A40" > a40-price.json
          curl -s "https://perfpertco.netlify.app/.netlify/functions/fetch-price?gpu=L4" > l4-price.json
          curl -s "https://perfpertco.netlify.app/.netlify/functions/fetch-price?gpu=L40" > l40-price.json
          curl -s "https://perfpertco.netlify.app/.netlify/functions/fetch-price?gpu=L40S" > l40s-price.json

      - name: Read current prices and update JSON
        run: |
          mkdir -p data
          if [ ! -f data/prices.json ]; then
            echo "[]" > data/prices.json
          fi

          h100_price=$(cat h100-price.json | jq -r '.price // "null"')
          gh200_price=$(cat gh200-price.json | jq -r '.price // "null"')
          a100_price=$(cat a100-price.json | jq -r '.price // "null"')
          a40_price=$(cat a40-price.json | jq -r '.price // "null"')
          l4_price=$(cat l4-price.json | jq -r '.price // "null"')
          l40_price=$(cat l40-price.json | jq -r '.price // "null"')
          l40s_price=$(cat l40s-price.json | jq -r '.price // "null"')

          current_date=$(date --utc +%Y-%m-%dT%H:%M:%SZ)

          # Apply VAT (1.19) to static prices correctly
          jq ". += [
            {\"gpu\": \"H100\", \"staticPrice\": (25818 * 1.19), \"livePrice\": $h100_price, \"date\": \"$current_date\", \"url\": \"https://www.deltacomputer.com/nvidia-h100-80gb.html\"},
            {\"gpu\": \"GH200\", \"staticPrice\": (25000 * 1.19), \"livePrice\": $gh200_price, \"date\": \"$current_date\", \"url\": \"https://www.deltacomputer.com/d14n-m2-gh-edu.html\"},
            {\"gpu\": \"A100\", \"staticPrice\": (7264 * 1.19), \"livePrice\": $a100_price, \"date\": \"$current_date\", \"url\": \"Not Available\"},
            {\"gpu\": \"A40\", \"staticPrice\": (4275 * 1.19), \"livePrice\": $a40_price, \"date\": \"$current_date\", \"url\": \"Not Available\"},
            {\"gpu\": \"L4\", \"staticPrice\": (2200 * 1.19), \"livePrice\": $l4_price, \"date\": \"$current_date\", \"url\": \"https://www.deltacomputer.com/nvidia-l4.html\"},
            {\"gpu\": \"L40\", \"staticPrice\": (6024 * 1.19), \"livePrice\": $l40_price, \"date\": \"$current_date\", \"url\": \"https://www.deltacomputer.com/nvidia-l40s-48gb-edu-startup.html\"},
            {\"gpu\": \"L40S\", \"staticPrice\": (6100 * 1.19), \"livePrice\": $l40s_price, \"date\": \"$current_date\", \"url\": \"https://www.deltacomputer.com/nvidia-l40s-48gb-edu-startup.html\"}
          ]" data/prices.json > data/temp-prices.json && mv data/temp-prices.json data/prices.json

      - name: Print debug info
        run: |
          echo "Git status:"
          git status
          echo "Listing contents of data folder:"
          ls -la data/
          echo "Contents of prices.json after update:"
          cat data/prices.json

      - name: Commit and push updated prices.json
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add data/prices.json
          git commit -m "Update GPU prices" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.MY_GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
